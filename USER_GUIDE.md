# 新功能使用指南

## 🔒 单元格锁定功能

### 如何锁定单元格
1. 将鼠标悬停在任意排班单元格上
2. 单元格左上角会出现一个灰色的解锁图标 🔓
3. 点击解锁图标，单元格被锁定
4. 锁定后显示绿色边框和绿色锁定图标 🔒

### 如何解锁单元格
1. 点击已锁定单元格左上角的绿色锁定图标 🔒
2. 单元格恢复正常状态

### 锁定的作用
- 被锁定的单元格不会被"智能一键排班"修改
- 被锁定的单元格不会被"一键优化"修改
- 适用场景：
  - 某些员工已确定的休假安排
  - 特殊的班次安排需要保留
  - 手动调整后不希望被自动修改的单元格

## ⚠️ 冲突详情查看

### 查看冲突
1. 页面右下角会显示冲突数量（红色警告框）
2. 点击红色警告框
3. 弹出冲突详情弹窗，显示所有冲突信息

### 冲突信息包含
- 冲突日期
- 冲突班次类型
- 错误描述
- 涉及的员工ID

## ✨ 一键优化功能

### 使用步骤
1. 点击页面右下角的冲突提示（红色警告框）
2. 在弹出的冲突详情弹窗中，点击"一键优化"按钮
3. 系统自动调用 OR-Tools 算法优化排班
4. 优化完成后，冲突应该被解决

### 优化规则
- 遵循所有排班规则（间隔、公平性等）
- **保留所有锁定的单元格**
- 最小化冲突和违规
- 优化跨月公平性

### 注意事项
- 优化前会自动备份当前排班
- 如果锁定的单元格过多，可能导致无解
- 优化后可以使用"回退"功能恢复

## ↩️ 回退优化功能

### 使用步骤
1. 点击页面右下角的冲突提示
2. 在弹出的冲突详情弹窗中，点击"回退优化"按钮
3. 排班恢复到点击"一键优化"之前的状态

### 注意事项
- 仅在执行过"一键优化"后才能回退
- 只能回退一次（不支持多次回退）
- 切换月份或组别后，备份会被清空

## 🎯 智能一键排班（已更新）

### 新特性
- 现在会**保留锁定的单元格**
- 锁定的单元格不会被重新分配

### 使用建议
1. 先手动锁定需要保留的单元格
2. 再点击"智能一键排班"
3. 系统会在保留锁定单元格的基础上生成排班

## 📋 完整工作流程示例

### 场景：部分员工已确定休假，需要自动排班

1. **锁定已确定的休假**
   - 找到对应员工和日期的单元格
   - 将班次设置为"休假"
   - 点击锁定图标 🔒

2. **执行智能排班**
   - 点击顶部"智能一键排班"按钮
   - 系统生成排班，保留锁定的休假安排

3. **检查冲突**
   - 查看右下角是否有冲突提示
   - 如有冲突，点击查看详情

4. **优化排班**
   - 在冲突详情弹窗中点击"一键优化"
   - 系统自动解决冲突

5. **如不满意，回退**
   - 点击"回退优化"恢复到优化前
   - 可以手动调整后再次优化

6. **保存排班**
   - 确认无误后，点击"保存排班"

## 💡 使用技巧

### 技巧1：先锁定关键单元格
在执行自动排班前，先锁定那些不能改变的单元格（如已批准的休假、特殊安排等）。

### 技巧2：分步优化
如果一次优化效果不理想，可以：
1. 回退优化
2. 锁定一些合理的单元格
3. 再次优化

### 技巧3：利用锁定减少冲突
如果某个日期总是出现冲突，可以尝试：
1. 手动调整该日期的排班
2. 锁定调整后的单元格
3. 优化其他日期

### 技巧4：批量处理
对于连续多天的特殊安排：
1. 逐个设置班次
2. 逐个锁定
3. 然后执行自动排班

## ⚙️ 快捷键（未来可能添加）

目前所有操作都通过鼠标点击完成。未来可能添加：
- `Ctrl + L`: 锁定/解锁选中单元格
- `Ctrl + Z`: 回退优化
- `Ctrl + O`: 一键优化

## 🐛 常见问题

### Q: 锁定的单元格刷新后消失了？
A: 是的，目前锁定状态不会保存到数据库。刷新页面或切换月份后需要重新锁定。

### Q: 一键优化后还有冲突怎么办？
A: 可能是因为：
1. 锁定的单元格本身存在冲突
2. 约束条件过于严格导致无完美解
3. 可以尝试解锁一些单元格后再次优化

### Q: 可以回退多次吗？
A: 目前只支持回退一次。如需多次调整，建议手动保存中间状态。

### Q: 锁定会影响算法性能吗？
A: 锁定少量单元格不会影响性能。但锁定过多（超过30%）可能导致求解时间变长或无解。

## 📞 反馈与建议

如有问题或建议，请联系开发团队或在项目 Issues 中提出。

---

**更新日期**: 2026-02-26
**版本**: v2.0
