# Bug Fixes - 2026-02-26

## 修复的问题

### 1. ✅ 单元格选择班次后不显示（主要问题）
**问题描述**：用户在单元格中选择班次类型后，后端API调用成功，但前端单元格仍然显示为空白。

**根本原因**：
- 后端返回的 `schedules` 数据中 `records` 数组为空（`Array(0)`）
- `App.tsx` 中的 `useEffect` 钩子（第219行）在后端模式下被跳过，导致员工记录从未被初始化到排班数据中
- 原代码：`if (isBackendAvailable) return;` 阻止了后端模式下的数据同步

**修复方案**：
- 移除了 `if (isBackendAvailable) return;` 条件判断
- 现在无论是后端模式还是本地模式，都会执行员工记录同步逻辑
- 确保每个员工在每个日期都有对应的记录（如果不存在则创建 `ShiftType.NONE` 记录）

**修改文件**：`web/App.tsx` (第219-235行)

```typescript
useEffect(() => {
  // 同步员工和排班数据：确保每个员工在每个日期都有记录
  setSchedules(prev => {
    if (prev.length === 0 || employees.length === 0) return prev;
    return prev.map(day => {
      const updatedRecords = employees.map(emp => {
        const existing = day.records.find(r => r.employeeId === emp.id);
        return existing || {
          employeeId: emp.id,
          date: day.date,
          type: ShiftType.NONE
        };
      });
      return { ...day, records: updatedRecords };
    });
  });
}, [employees]);
```

---

### 2. ✅ 最下面几行的下拉框被遮挡
**问题描述**：在表格底部行点击单元格时，下拉菜单被页面底部遮挡，无法完整显示。

**根本原因**：
- 下拉菜单使用 `absolute` 定位，受父容器 `overflow` 属性限制
- `z-index` 为 100，可能被其他元素覆盖
- 虽然有检测上下空间的逻辑，但定位方式不够灵活

**修复方案**：
- 将下拉菜单定位从 `absolute` 改为 `fixed`
- 提高 `z-index` 到 9999，确保在最顶层
- 使用 `getBoundingClientRect()` 动态计算下拉菜单的绝对位置
- 根据 `dropdownAbove` 状态自动调整显示方向（向上或向下）
- 添加滚动事件监听器，滚动时自动关闭下拉菜单

**修改文件**：`web/components/MatrixGrid.tsx`

**关键改动**：
1. 下拉菜单定位（第483-496行）：
```typescript
{showDropdown && (
  <div
    className={`fixed z-[9999] bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-700 py-1 min-w-[90px]`}
    style={{
      left: cellRef.current ? `${cellRef.current.getBoundingClientRect().left + cellRef.current.getBoundingClientRect().width / 2}px` : '0',
      transform: 'translateX(-50%)',
      top: dropdownAbove
        ? cellRef.current ? `${cellRef.current.getBoundingClientRect().top - 8}px` : '0'
        : cellRef.current ? `${cellRef.current.getBoundingClientRect().bottom + 8}px` : '0',
      ...(dropdownAbove && { transform: 'translate(-50%, -100%)' })
    }}
    onClick={(e) => e.stopPropagation()}
  >
```

2. 滚动事件监听（第333-353行）：
```typescript
useEffect(() => {
  if (!showDropdown) return;
  const handler = (e: MouseEvent) => {
    if (cellRef.current && !cellRef.current.contains(e.target as Node)) {
      setShowDropdown(false);
      setShowCustomInput(false);
      setCustomText('');
    }
  };
  const scrollHandler = () => {
    setShowDropdown(false);
    setShowCustomInput(false);
    setCustomText('');
  };
  document.addEventListener('mousedown', handler);
  window.addEventListener('scroll', scrollHandler, true);
  return () => {
    document.removeEventListener('mousedown', handler);
    window.removeEventListener('scroll', scrollHandler, true);
  };
}, [showDropdown]);
```

---

### 3. ✅ 最后一行点击单元格没反应
**问题描述**：表格最后一行的单元格点击后没有响应，无法打开下拉菜单。

**根本原因**：
- 这是问题1的连锁反应：由于 `records` 数组为空，MatrixGrid 没有渲染任何单元格
- 没有单元格就无法响应点击事件

**修复方案**：
- 通过修复问题1（确保每个员工都有记录），自动解决了此问题
- 现在所有行的单元格都能正常渲染和响应点击

---

## 代码清理

移除了所有调试用的 `console.log` 语句：
- `web/App.tsx`：移除了 `filteredSchedules` 中的调试日志
- `web/components/MatrixGrid.tsx`：移除了 `useEffect` 中的调试日志

---

## 测试建议

1. **测试单元格选择**：
   - 在任意单元格点击并选择班次类型
   - 验证选择后单元格立即显示对应的班次标签和颜色
   - 刷新页面后验证数据持久化

2. **测试下拉菜单定位**：
   - 在表格顶部行点击单元格，验证下拉菜单向下显示
   - 在表格底部行点击单元格，验证下拉菜单向上显示
   - 滚动页面时验证下拉菜单自动关闭

3. **测试最后一行**：
   - 点击最后一行的任意单元格
   - 验证下拉菜单正常打开且向上显示
   - 验证可以正常选择班次类型

---

## 技术要点

### 1. React 状态同步
- 使用 `useEffect` 监听 `employees` 变化
- 确保 `schedules` 中的 `records` 数组始终包含所有员工
- 保留已存在的记录，只为新员工创建空记录

### 2. Fixed 定位的优势
- 不受父容器 `overflow` 限制
- 可以突破容器边界显示
- 需要手动计算绝对位置

### 3. 动态位置计算
- 使用 `getBoundingClientRect()` 获取元素位置
- 根据视口空间动态决定显示方向
- 使用 `transform` 实现居中对齐

---

## 影响范围

- ✅ 不影响现有功能
- ✅ 不改变数据结构
- ✅ 不影响后端API
- ✅ 向后兼容

---

**修复完成时间**：2026-02-26
**构建状态**：✅ 成功（无语法错误）
